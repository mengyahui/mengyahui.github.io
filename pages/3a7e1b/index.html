<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Nginx | MYH&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.9.5">
    <script src="https://cdn.jsdelivr.net/npm/react/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="web前端技术博客,专注web前端学习与总结。JavaScript,js,ES6,TypeScript,vue,React,python,css3,html5,Node,git,github等技术文章。">
    <meta name="keywords" content="博客,个人技术博客,后端,后端开发,后端框架,web前端,后端面试题,技术文档,学习,面试,Java,SpringBoot,MyBatis,MySQL,vue,Redis,SpringCloud,Nginx,MongoDB,git,Docker,markdown">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.042d882d.css" as="style"><link rel="preload" href="/assets/js/app.67223bcb.js" as="script"><link rel="preload" href="/assets/js/2.316bc55b.js" as="script"><link rel="preload" href="/assets/js/48.5e0e4526.js" as="script"><link rel="prefetch" href="/assets/js/10.a19925fb.js"><link rel="prefetch" href="/assets/js/11.526b83d6.js"><link rel="prefetch" href="/assets/js/12.5565edc8.js"><link rel="prefetch" href="/assets/js/13.3d6970aa.js"><link rel="prefetch" href="/assets/js/14.8eedc93a.js"><link rel="prefetch" href="/assets/js/15.d2da9468.js"><link rel="prefetch" href="/assets/js/16.c8ffcd7f.js"><link rel="prefetch" href="/assets/js/17.79b69729.js"><link rel="prefetch" href="/assets/js/18.55f1e803.js"><link rel="prefetch" href="/assets/js/19.f1227afb.js"><link rel="prefetch" href="/assets/js/20.e45349ee.js"><link rel="prefetch" href="/assets/js/21.1d53685b.js"><link rel="prefetch" href="/assets/js/22.59de4a41.js"><link rel="prefetch" href="/assets/js/23.35180819.js"><link rel="prefetch" href="/assets/js/24.8d404f24.js"><link rel="prefetch" href="/assets/js/25.3a005120.js"><link rel="prefetch" href="/assets/js/26.68cd2eea.js"><link rel="prefetch" href="/assets/js/27.39d3184a.js"><link rel="prefetch" href="/assets/js/28.39252e9a.js"><link rel="prefetch" href="/assets/js/29.8cfc649d.js"><link rel="prefetch" href="/assets/js/3.9a800561.js"><link rel="prefetch" href="/assets/js/30.8b9d3130.js"><link rel="prefetch" href="/assets/js/31.615bad2f.js"><link rel="prefetch" href="/assets/js/32.6ed3ef0f.js"><link rel="prefetch" href="/assets/js/33.66731721.js"><link rel="prefetch" href="/assets/js/34.1579207c.js"><link rel="prefetch" href="/assets/js/35.86ff114a.js"><link rel="prefetch" href="/assets/js/36.4aa49dd5.js"><link rel="prefetch" href="/assets/js/37.d6a0a8ea.js"><link rel="prefetch" href="/assets/js/38.cdd7fc8e.js"><link rel="prefetch" href="/assets/js/39.34a896dc.js"><link rel="prefetch" href="/assets/js/4.d1b60869.js"><link rel="prefetch" href="/assets/js/40.d3ba7ebb.js"><link rel="prefetch" href="/assets/js/41.13dd3c48.js"><link rel="prefetch" href="/assets/js/42.44d4fbb4.js"><link rel="prefetch" href="/assets/js/43.0679497a.js"><link rel="prefetch" href="/assets/js/44.09c31938.js"><link rel="prefetch" href="/assets/js/45.40d49eef.js"><link rel="prefetch" href="/assets/js/46.3aa471f6.js"><link rel="prefetch" href="/assets/js/47.db96e5fd.js"><link rel="prefetch" href="/assets/js/49.a3a85982.js"><link rel="prefetch" href="/assets/js/5.251bc32b.js"><link rel="prefetch" href="/assets/js/50.9ba01c48.js"><link rel="prefetch" href="/assets/js/51.dd99cdbc.js"><link rel="prefetch" href="/assets/js/52.6df8e45e.js"><link rel="prefetch" href="/assets/js/53.1e4cb3b8.js"><link rel="prefetch" href="/assets/js/54.3f0aee84.js"><link rel="prefetch" href="/assets/js/55.90b58b90.js"><link rel="prefetch" href="/assets/js/56.1ae97e41.js"><link rel="prefetch" href="/assets/js/57.4c7cbc1f.js"><link rel="prefetch" href="/assets/js/58.b60428fc.js"><link rel="prefetch" href="/assets/js/59.357d5e5e.js"><link rel="prefetch" href="/assets/js/6.559acfe3.js"><link rel="prefetch" href="/assets/js/7.74bb28c3.js"><link rel="prefetch" href="/assets/js/8.45d5678b.js"><link rel="prefetch" href="/assets/js/9.52b09d04.js">
    <link rel="stylesheet" href="/assets/css/0.styles.042d882d.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="MYH's Blog" class="logo"> <span class="site-name can-hide">MYH's Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><a href="/front-end/" class="link-title">前端</a> <span class="title" style="display:none;">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/24a8e1/" class="nav-link">CSS</a></li><li class="dropdown-item"><!----> <a href="/pages/f4d72c/" class="nav-link">Vue</a></li><li class="dropdown-item"><!----> <a href="/pages/e44a21/" class="nav-link">JavaScript</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><a href="/back-end/" class="link-title">后端</a> <span class="title" style="display:none;">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/cd256c/" class="nav-link">SpringBoot</a></li><li class="dropdown-item"><!----> <a href="/pages/58a1d3/" class="nav-link">SpringCloud</a></li><li class="dropdown-item"><!----> <a href="/pages/b81f92/" class="nav-link">MyBatis</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><a href="/database/" class="link-title">数据库</a> <span class="title" style="display:none;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/680c6f/" class="nav-link">elasticsearch</a></li><li class="dropdown-item"><!----> <a href="/pages/330887/" class="nav-link">mysql</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具" class="dropdown-title"><a href="/tools/" class="link-title">工具</a> <span class="title" style="display:none;">工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/01e90a/" class="nav-link">Git</a></li><li class="dropdown-item"><!----> <a href="/pages/f8ef21/" class="nav-link">Docker</a></li><li class="dropdown-item"><!----> <a href="/pages/3a7e1b/" aria-current="page" class="nav-link router-link-exact-active router-link-active">Nginx</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/f1db9f/" class="nav-link">学习</a></li><li class="dropdown-item"><!----> <a href="/pages/3c70e5/" class="nav-link">面试</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/logo.png"> <div class="blogger-info"><h3>MYH</h3> <span>这家伙很懒，什么都没写......</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><a href="/front-end/" class="link-title">前端</a> <span class="title" style="display:none;">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/24a8e1/" class="nav-link">CSS</a></li><li class="dropdown-item"><!----> <a href="/pages/f4d72c/" class="nav-link">Vue</a></li><li class="dropdown-item"><!----> <a href="/pages/e44a21/" class="nav-link">JavaScript</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><a href="/back-end/" class="link-title">后端</a> <span class="title" style="display:none;">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/cd256c/" class="nav-link">SpringBoot</a></li><li class="dropdown-item"><!----> <a href="/pages/58a1d3/" class="nav-link">SpringCloud</a></li><li class="dropdown-item"><!----> <a href="/pages/b81f92/" class="nav-link">MyBatis</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><a href="/database/" class="link-title">数据库</a> <span class="title" style="display:none;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/680c6f/" class="nav-link">elasticsearch</a></li><li class="dropdown-item"><!----> <a href="/pages/330887/" class="nav-link">mysql</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具" class="dropdown-title"><a href="/tools/" class="link-title">工具</a> <span class="title" style="display:none;">工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/01e90a/" class="nav-link">Git</a></li><li class="dropdown-item"><!----> <a href="/pages/f8ef21/" class="nav-link">Docker</a></li><li class="dropdown-item"><!----> <a href="/pages/3a7e1b/" aria-current="page" class="nav-link router-link-exact-active router-link-active">Nginx</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/f1db9f/" class="nav-link">学习</a></li><li class="dropdown-item"><!----> <a href="/pages/3c70e5/" class="nav-link">面试</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Git</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/01e90a/" class="sidebar-link">Git总结</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Docker</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Nginx</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/tools/#工具" data-v-06225672>工具</a></li><li data-v-06225672><a href="/tools/#Nginx" data-v-06225672>Nginx</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/mengyahui" target="_blank" title="作者" class="beLink" data-v-06225672>MYH</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2023-06-16</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">Nginx<!----></h1>  <div class="theme-vdoing-content content__default"><h2 id="一、nginx-概述"><a href="#一、nginx-概述" class="header-anchor">#</a> 一、nginx 概述</h2> <p>nginx 是一款轻量级HTTP和反向代理服务器，同时也是一个 IMAP/POP3/SMTP 代理服务器，特点是占有内存少，并发能力强，事实上nginx 的并发能力确实在同类型的网页服务器中表现较好，中国大陆使用Nginx网站用户有：百度、京东、新浪、网易、腾讯、淘宝等。</p> <p>nginx 具有如下特点：</p> <ul><li>更快：单次请求响应更快，高并发可以更快的处理响应；</li> <li>高拓展性：设计极具扩展性，由多个不同功能、不同层次、不同类型且耦合度极低的模块组成；</li> <li>高可靠性：很多高流量网站都在核心服务器上大规模使用 nginx；</li> <li>低内存消耗：一般1万个非活跃的 HTTP Keep-Alive 连接在 nginx 中仅消耗 2.5MB 内存；</li> <li>高并发：单机支持 10 万以上的并发连接；</li> <li>热部署：master 管理进程与 worker工作进程的分离设计，使得 nginx 能够支持热部署；</li> <li>开源协议：使用 BSD 许可协议，免费使用，且可修改源码。</li></ul> <p>nginx 的主要应用场景如下：</p> <p><img src="https://cdn.jsdelivr.net/gh/mengyahui/image-repository@master/nginx/Nginx.xxk748tr75s.webp" alt="Nginx"></p> <h2 id="二、关于代理"><a href="#二、关于代理" class="header-anchor">#</a> 二、关于代理</h2> <p>nginx 是一款反向代理服务器，什么是反向代理呢？与之相对的，什么又是正向代理呢？</p> <p><strong>正向代理：</strong></p> <p>正向代理（forward）意思是一个位于客户端和原始服务器 (origin server) 之间的服务器，为了从原始服务器取得内容，客户端向代理发送一个请求并指定目标 (原始服务器)，然后代理向原始服务器转交请求并将获得的内容返回给客户端。</p> <p>正向代理是为客户端服务的，客户端可以根据正向代理访问到它本身无法访问到的服务器资源。</p> <p><img src="https://cdn.jsdelivr.net/gh/mengyahui/image-repository@master/nginx/image-20230616192510073.42mkn55efco0.webp" alt="image-20230616192510073"></p> <p>在访问谷歌的时候，由于防火墙的存在是不能直接访问的，但可以借助 VPN 来实现，这就是一个简单的正向代理的例子。正向代理 “代理” 的是客户端，而且客户端是知道目标的，而目标是不知道客户端是通过 VPN 访问的。</p> <p><strong>反向代理：</strong></p> <p>反向代理（Reverse Proxy）方式是指以代理服务器来接受 internet 上的连接请求，然后将请求转发给内部网络上的服务器，并将从服务器上得到的结果返回给 internet 上请求连接的客户端，此时代理服务器对外就表现为一个反向代理服务器。</p> <p>反向代理是为服务端服务的，反向代理可以帮助服务器接收来自客户端的请求，帮助服务器做请求转发，负载均衡等。</p> <p><img src="https://cdn.jsdelivr.net/gh/mengyahui/image-repository@master/nginx/image-20230616195719028.rmsqsaurl7k.webp" alt="image-20230616195719028"></p> <p><strong>二者的区别：</strong></p> <p>正向代理对客户端是透明的，对服务端是非透明的，即服务端并不知道自己收到的是来自代理的访问还是来自真实客户端的访问。</p> <p>反向代理对服务端是透明的，对客户端是非透明的，即客户端并不知道自己访问的是代理服务器，而服务器知道反向代理在为他服务。</p> <h2 id="三、安装-nginx"><a href="#三、安装-nginx" class="header-anchor">#</a> 三、安装 nginx</h2> <p>虚拟机软件：VMWare Workstation 17 Pro.</p> <p>操作系统：CentOS 7.9</p> <ol><li>添加 nginx 的 yum 仓库：</li></ol> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 创建文件夹使用vim编辑</span>
<span class="token function">vim</span> /etc/yum.repos.d/nginx.repo

<span class="token comment"># 填写以下内容并保存</span>
<span class="token punctuation">[</span>nginx-stable<span class="token punctuation">]</span>
<span class="token assign-left variable">name</span><span class="token operator">=</span>nginx stable repo
<span class="token assign-left variable">baseurl</span><span class="token operator">=</span>http://nginx.org/packages/centos/<span class="token punctuation">\</span><span class="token variable">$releasever</span>/<span class="token punctuation">\</span><span class="token variable">$basearch</span>/
<span class="token assign-left variable">gpgcheck</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token assign-left variable">enabled</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token assign-left variable">gpgkey</span><span class="token operator">=</span>https://nginx.org/keys/nginx_signing.key
<span class="token assign-left variable">module_hotfixes</span><span class="token operator">=</span>true
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ol start="2"><li>安装 nginx：</li></ol> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>yum <span class="token parameter variable">-y</span> <span class="token function">install</span> nginx
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>安装完成后可使用 <code>rpm -ql nginx</code> 命令查看 nginx 的安装信息，我们只需关注其中的两个安装配置：</p> <p><code>/etc/nginx/conf.d</code>：子配置项的存放处，<code>/etc/nginx/nginx.conf</code> 主配置文件会默认把这个文件夹中所有子配置项都引入；</p> <p><code>/usr/share/nginx/html</code>：静态文件都放在这个文件夹，也可以根据你自己的习惯放在其他地方；</p> <h2 id="四、nginx-常用命令"><a href="#四、nginx-常用命令" class="header-anchor">#</a> 四、nginx 常用命令</h2> <h3 id="_4-1-系统命令"><a href="#_4-1-系统命令" class="header-anchor">#</a> 4.1 系统命令</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>systemctl <span class="token builtin class-name">enable</span> nginx 			<span class="token comment"># 开机自动启动</span>
systemctl disable nginx 		<span class="token comment"># 关闭开机自动启动</span>

systemctl start nginx 			<span class="token comment"># 启动 nginx</span>
systemctl stop nginx 			<span class="token comment"># 停止 nginx</span>

systemctl restart nginx 		<span class="token comment"># 重启 nginx</span>
systemctl reload nginx 			<span class="token comment"># 重新加载 nginx</span>

systemctl status nginx 			<span class="token comment"># 查看 nginx 运行状态</span>
<span class="token function">ps</span> <span class="token parameter variable">-ef</span> <span class="token operator">|</span> <span class="token function">grep</span> nginx 			<span class="token comment"># 查看 nginx 进程</span>
<span class="token function">kill</span> <span class="token parameter variable">-9</span> pid 					<span class="token comment"># 根据上面查看到的 nginx 进程号，杀死 nginx 进程，-9 表示强制结束进程</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="_4-2-nginx-命令"><a href="#_4-2-nginx-命令" class="header-anchor">#</a> 4.2 nginx 命令</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>nginx <span class="token parameter variable">-s</span> reload  		<span class="token comment"># 向主进程发送信号，重新加载配置文件，热重启</span>
nginx <span class="token parameter variable">-s</span> reopen  		<span class="token comment"># 重启 </span>
nginx <span class="token parameter variable">-s</span> stop    		<span class="token comment"># 快速关闭</span>
nginx <span class="token parameter variable">-s</span> quit    		<span class="token comment"># 等待工作进程处理完成后关闭</span>
nginx <span class="token parameter variable">-T</span>         		<span class="token comment"># 查看当前 nginx 最终的配置</span>
nginx <span class="token parameter variable">-t</span>         		<span class="token comment"># 检查配置是否有问题</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="五、nginx-配置文件"><a href="#五、nginx-配置文件" class="header-anchor">#</a> 五、nginx 配置文件</h2> <p>nginx 配置文件主要分为如下几个模块：</p> <ol><li>全局配置模块，影响 nginx 的全局配置；</li> <li>events 模块，影响 nginx 服务器与用户的网络连接；</li> <li>http 模块，用于代理，缓存，日志定义等绝大多数功能和第三方模块的配置；</li> <li>server 模块，用于配置虚拟主机的相关参数，一个 http 模块中可以有多个 server 模块；</li> <li>location 模块，用于配置匹配的 uri ；</li> <li>upstream 模块，用于配置后端服务器具体地址，是负载均衡配置不可或缺的部分。</li></ol> <p>下面是一个比较完整的 nginx.conf 配置文件：</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token comment"># 全局配置模块</span>
<span class="token directive"><span class="token keyword">user</span>  nginx</span><span class="token punctuation">;</span>                        		<span class="token comment"># 运行用户，默认即是 nginx，可以不进行设置</span>
<span class="token directive"><span class="token keyword">worker_processes</span>  auto</span><span class="token punctuation">;</span>             		<span class="token comment"># nginx 进程数，一般设置为和 CPU 核心数一样</span>
<span class="token comment"># nginx 的错误日志存放目录,和日志级别，从高到低分别是debug—info—notice—warning—error—critic,含义分别是测试、显示、通知、警告、报错和紧急,显示信息逐步减少。在生产环境中,我们一般将日志级别定义为warning及以上。</span>
<span class="token directive"><span class="token keyword">error_log</span>  /var/log/nginx/error.log warn</span><span class="token punctuation">;</span>   
<span class="token directive"><span class="token keyword">pid</span>        /var/run/nginx.pid</span><span class="token punctuation">;</span>      		<span class="token comment"># nginx 服务启动时的 pid 存放位置</span>

<span class="token comment"># events 模块</span>
<span class="token directive"><span class="token keyword">events</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">use</span> epoll</span><span class="token punctuation">;</span><span class="token comment"># 使用epoll的I/O模型(如果你不知道nginx该使用哪种轮询方法,会自动选择一个最适合你操作系统的)</span>
    <span class="token directive"><span class="token keyword">worker_connections</span> <span class="token number">1024</span></span><span class="token punctuation">;</span>   <span class="token comment"># 每个进程允许最大并发数</span>
<span class="token punctuation">}</span>

<span class="token comment"># http 模块</span>
<span class="token comment"># 配置使用最频繁的部分，代理、缓存、日志定义等绝大多数功能和第三方模块的配置都在这里设置</span>
<span class="token directive"><span class="token keyword">http</span></span> <span class="token punctuation">{</span> 
    <span class="token comment"># 设置日志格式</span>
    <span class="token directive"><span class="token keyword">log_format</span>  main  <span class="token string">'<span class="token variable">$remote_addr</span> - <span class="token variable">$remote_user</span> [<span class="token variable">$time_local]</span> &quot;<span class="token variable">$request</span>&quot; '</span>
                      <span class="token string">'<span class="token variable">$status</span> <span class="token variable">$body_bytes_sent</span> &quot;<span class="token variable">$http_referer</span>&quot; '</span>
                      <span class="token string">'&quot;<span class="token variable">$http_user_agent</span>&quot; &quot;<span class="token variable">$http_x_forwarded_for</span>&quot;'</span></span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">access_log</span>  /var/log/nginx/access.log  main</span><span class="token punctuation">;</span>   <span class="token comment"># nginx访问日志存放位置</span>

    <span class="token directive"><span class="token keyword">sendfile</span>            <span class="token boolean">on</span></span><span class="token punctuation">;</span>   <span class="token comment"># 开启高效传输模式</span>
    <span class="token directive"><span class="token keyword">tcp_nopush</span>          <span class="token boolean">on</span></span><span class="token punctuation">;</span>   <span class="token comment"># 减少网络报文段的数量</span>
    <span class="token directive"><span class="token keyword">tcp_nodelay</span>         <span class="token boolean">on</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">keepalive_timeout</span>   <span class="token number">65</span></span><span class="token punctuation">;</span>   <span class="token comment"># 保持连接的时间，也叫超时时间，单位秒</span>
    <span class="token directive"><span class="token keyword">types_hash_max_size</span> <span class="token number">2048</span></span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">include</span>             /etc/nginx/mime.types</span><span class="token punctuation">;</span>      <span class="token comment"># 文件扩展名与类型映射表</span>
    <span class="token directive"><span class="token keyword">default_type</span>        application/octet-stream</span><span class="token punctuation">;</span>   <span class="token comment"># 默认文件类型</span>

    <span class="token directive"><span class="token keyword">include</span> /etc/nginx/conf.d/*.conf</span><span class="token punctuation">;</span>   <span class="token comment"># 加载子配置项</span>
    
    <span class="token comment"># server模块</span>
    <span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
     <span class="token directive"><span class="token keyword">listen</span>       <span class="token number">80</span></span><span class="token punctuation">;</span>           <span class="token comment"># 配置监听的端口</span>
     <span class="token directive"><span class="token keyword">server_name</span>  localhost</span><span class="token punctuation">;</span>    <span class="token comment"># 配置的域名</span>
      
     <span class="token comment"># location模块</span>
     <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
      <span class="token directive"><span class="token keyword">root</span>   /usr/share/nginx/html</span><span class="token punctuation">;</span>  <span class="token comment"># 网站根目录</span>
      <span class="token directive"><span class="token keyword">index</span>  index.html index.htm</span><span class="token punctuation">;</span>   <span class="token comment"># 默认首页文件</span>
      <span class="token directive"><span class="token keyword">deny</span> 172.168.22.11</span><span class="token punctuation">;</span>   <span class="token comment"># 禁止访问的ip地址，可以为all</span>
      allow 172.168.33.44；# 允许访问的ip地址，可以为all
     <span class="token punctuation">}</span>
     
     <span class="token directive"><span class="token keyword">error_page</span> <span class="token number">500</span> <span class="token number">502</span> <span class="token number">503</span> <span class="token number">504</span> /50x.html</span><span class="token punctuation">;</span>  <span class="token comment"># 默认50x对应的访问页面</span>
     <span class="token directive"><span class="token keyword">error_page</span> <span class="token number">400</span> <span class="token number">404</span> error.html</span><span class="token punctuation">;</span>   <span class="token comment"># 同上</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><h2 id="六、location-指令详解"><a href="#六、location-指令详解" class="header-anchor">#</a> 六、location 指令详解</h2> <p>location 是 nginx 中的块级指令(block directive)，其功能是用来匹配不同的 URI 请求，进而对请求做不同的处理和响应，语法格式如下：</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">location</span> [ = | ~ | ~* | ^~ ] uri</span> <span class="token punctuation">{</span> … <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="_6-1-uri-路径匹配"><a href="#_6-1-uri-路径匹配" class="header-anchor">#</a> 6.1 URI 路径匹配</h3> <p>URI 前面的参数叫做路径通配符，含义如下：</p> <ul><li><p><code>=</code>：表示精确匹配；</p></li> <li><p><code>~</code>：表示区分大小写的正则匹配；</p></li> <li><p><code>~*</code> ：表示不区分大小写的正则匹配；</p></li> <li><p><code>^~</code>：表示 uri 以某个常规字符串开头，不是正则匹配。</p></li></ul> <p>优先级：</p> <ol><li>等号类型（=）的优先级最高。一旦匹配成功，则不再查找其它 location 的匹配项；</li> <li>^~ 和 /，使用前缀匹配，不支持正则表达式，如果有多个 location 匹配成功的话，不会终止匹配过程，<strong>会匹配表达式最长的那个</strong></li> <li>如果上一步得到的最长的 location 为 ^~ 类型，则表示阻断正则表达式，不再匹配正则表达式；</li> <li>如果上一步得到的最长的 location 不是 ^~ 类型，继续匹配正则表达式，只要有一个正则成功，则使用这个正则的 location，立即返回结果，并结束解析过程。</li></ol> <h3 id="_6-2-root-指令"><a href="#_6-2-root-指令" class="header-anchor">#</a> 6.2 root 指令</h3> <p>在 location 命中后，若其下配置的是 root 指，则会在 root 指令配置的文件夹内寻找资源，并把 location 配置路径附加到其后</p> <p>例如，我们的请求是：/js/jquery.js ，location 配置如下：</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">location</span> /js</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">root</span> /home/static/</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>则实际返回的是 /home/static/js 下的 jsquey.js 文件。此外，location 内部默认配置了一条规则 <code>index index.html</code> ，当实际访问的是一个目录时，会返回该目录中 index 指令指定的文件，如果该目录中不存在该文件，则会返回 403。</p> <h3 id="_6-3-alias-指令"><a href="#_6-3-alias-指令" class="header-anchor">#</a> 6.3 alias 指令</h3> <p>和 root 不同的是，在 location 命中后，会将 location 配置的 uri 指向 alias 配置的路径，且不会拼接上 location 配置的路径，且 alias 配置的最后一定要有 <code>/</code> ，而 root 可以没有。</p> <p>例如，我们的请求是：/static/logo.png ，location 配置如下：</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">location</span> /static</span> <span class="token punctuation">{</span>
	alias /home/static/
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>则实际返回的是 /home/static/logo.png 文件。</p> <h3 id="_6-4-proxy-pass-指令"><a href="#_6-4-proxy-pass-指令" class="header-anchor">#</a> 6.4 proxy_pass 指令</h3> <p>location 下的 proxy_pass 用于代理请求，location 命中后，会将请求通过 proxy_pass 指定的 URL 进行转发。</p> <p>若 proxy-pass 的地址只配置到端口，不包含<code>/</code>或其他路径，那么 location 将被追加到转发地址中：</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">location</span> /some/path/</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">proxy_pass</span> http://localhost:8080</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>像上面那样，如果请求的路径为 http://localhost/som/path/page.html ，则实际的请求地址为 http://localhost:8080/some/path/page.html</p> <p>若 proxy-pass 的地址包含 <code>/</code> 相关路径，则 <code>/</code> 相关路径将会被 location 的路径替换：</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">location</span> /some/path/</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">proxy_pass</span> http://localhost:8080/zh-cn/</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>像上面那样，如果请求的路径为 http://localhost/som/path/page.html ，则实际的请求地址为 http://localhost:8080/zh-ch/page.html</p> <h2 id="七、nginx-部署案例"><a href="#七、nginx-部署案例" class="header-anchor">#</a> 七、nginx 部署案例</h2> <h3 id="_7-0-环境搭建"><a href="#_7-0-环境搭建" class="header-anchor">#</a> 7.0 环境搭建</h3> <h4 id="_7-0-1-安装-jdk"><a href="#_7-0-1-安装-jdk" class="header-anchor">#</a> 7.0.1 安装 JDK</h4> <ol><li>检查是否已经安装 JDK，命令为：<code>yum list installed | grep jdk</code></li> <li>查看 JDK 软件包列表，命令为：<code>yum search java | grep -i --color jdk</code></li> <li>安装 JDK，命令为：<code>yum install -y java-11-openjdk.x86_64</code></li> <li>查看是否安装成功，命令为：<code>java -version</code></li> <li>卸载 JDK，命令为：<code>yum remove -y java-11-openjdk.x86_64</code></li></ol> <h4 id="_7-0-2-安装-mysql"><a href="#_7-0-2-安装-mysql" class="header-anchor">#</a> 7.0.2 安装 MySQL</h4> <p>为了方便，这里选择使用 Docker 安装 MySQL。</p> <ol><li>拉取 MySQL 镜像，命令为：<code>docker pull mysql:8.0.17</code></li> <li>运行 MySQL 容器，命令如下：</li></ol> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">docker</span> run <span class="token punctuation">\</span>
<span class="token parameter variable">-p</span> <span class="token number">3306</span>:3306 <span class="token punctuation">\</span>
<span class="token parameter variable">--name</span> mysql <span class="token punctuation">\</span>
<span class="token parameter variable">-v</span> /docker/mysql/logs:/logs <span class="token punctuation">\</span>
<span class="token parameter variable">-v</span> /docker/mysql/data:/var/lib/mysql <span class="token punctuation">\</span>
<span class="token parameter variable">-v</span> /docker/mysql/conf:/etc/mysql/conf.d <span class="token punctuation">\</span>
<span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_ROOT_PASSWORD</span><span class="token operator">=</span>root <span class="token punctuation">\</span>
<span class="token parameter variable">-d</span> mysql:8.0.17
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="_7-0-3-准备部署项目"><a href="#_7-0-3-准备部署项目" class="header-anchor">#</a> 7.0.3 准备部署项目</h4> <p>静态网页使用 AdminLTE-3.2.0，Java 项目选择若依项目打包后的 jar 包和 war 包，名字分别为：ruoyi-admin.jar 和 ruoyi-admin.war，在本地均已调试好。部署 ruoyi-admin.war 的 Tomcat 服务器选择 apache-tomcat-8.5.81。</p> <p>以上资源均放到了 /home/apps/ 目录下。除此之外，本地虚拟机的 IP 为 192.168.184.129。</p> <p>为了方便修改配置文件，这里选择使用在 vscode 中使用 Remote-SSH 插件来连接 Linux 虚拟机，使用 NGINX Configuration 插件来使 nginx 的配置文件语法高亮。</p> <p><img src="https://cdn.jsdelivr.net/gh/mengyahui/image-repository@master/nginx/image-20230617170910081.3l05ryc44v8.webp" alt="image-20230617170910081"></p> <p>连接上虚拟机后，打开 /etc/nginx/ 目录，查看其中的 nginx.conf 文件，可以看到 /etc/nginx/conf.d/ 目录下的配置文件也会被加载，所以在部署项目时，只需要在这个目录下新建配置文件即可。</p> <h3 id="_7-1-静态网页"><a href="#_7-1-静态网页" class="header-anchor">#</a> 7.1 静态网页</h3> <p>在 /etc/nginx/conf.d/ 目录下新建 8000-adminLTE.conf 文件，写入如下内容：</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">server</span></span><span class="token punctuation">{</span>
  
    <span class="token directive"><span class="token keyword">listen</span> <span class="token number">8000</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span> localhost</span><span class="token punctuation">;</span>
    
    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">root</span> /home/apps/AdminLTE-3.2.0</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">index</span> index.html index2.html index3.html</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>listen 监听可以配置成 IP 或 port 或 IP + port；server_name 主要用于区分不同的 server，可以随便起，也可以使用变量 <code>$hostname</code> 配置成主机名。</p> <p>最后，访问 192.168.184.129:8000 检查静态网页是否部署成功。</p> <h3 id="_7-2-http-反向代理"><a href="#_7-2-http-反向代理" class="header-anchor">#</a> 7.2 HTTP 反向代理</h3> <p>首先，使用命令 <code>java -jar ruoyi-admin.jar</code> 启动 ruoyi-admin，ruoyi-admin 项目配置的端口是 8088，访问 <code>192.168.184.129:8088</code> 检查项目是否启动。</p> <p>然后在 /etc/nginx/conf.d/ 目录下新建 8001-ruoyi-jar.conf 配置文件，写入如下内容：</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
  
  <span class="token directive"><span class="token keyword">listen</span> <span class="token number">8001</span></span><span class="token punctuation">;</span>
  <span class="token directive"><span class="token keyword">server_name</span> ruoyi.jar</span><span class="token punctuation">;</span>
  
  <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">proxy_pass</span> http://localhost:8088</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>使用 <code>nginx -s reload</code> 重新加载配置文件，访问：<code>192.168.184.129:8001</code> 检查 HTTP 反向代理是否成功。</p> <p>由于使用反向代理之后，后端服务无法获取用户的真实 IP，所以，一般反向代理都会设置以下 header 信息。</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
    <span class="token comment">#nginx的主机地址</span>
    <span class="token directive"><span class="token keyword">proxy_set_header</span> Host <span class="token variable">$http_host</span></span><span class="token punctuation">;</span>
    <span class="token comment">#用户端真实的IP，即客户端IP</span>
    <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Real-IP <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span></span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">proxy_pass</span> http://localhost:8088</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="_7-3-动静分离"><a href="#_7-3-动静分离" class="header-anchor">#</a> 7.3 动静分离</h3> <p>Apache Tocmat 严格来说是一款 Java EE 服务器，主要是用来处理  Servlet 请求。处理 css、js、图片这些静态文件的 IO 性能不够好，因此，将静态文件交给 nginx 处理，可以提高系统的访问速度，减少 tomcat 的请求次数，有效的给后端服务器降压。</p> <ol><li>将 ruoyi-admin.war 移动到 tomcat 解压目录的 webapps 目录下，并重命名为 ROOT.war，同时删除 ROOT 目录</li></ol> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">mv</span> /home/apps/ruoyi-admin.war /home/apps/apache-tomcat-8.5.81/webapps/ROOT.war
<span class="token function">rm</span> <span class="token parameter variable">-rf</span> //home/apps/apache-tomcat-8.5.81/webapps/ROOT
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ol start="2"><li><p>在 tomcat 的 bin 目录下执行命令 <code>sh startup.sh</code> 运行 tomcat 服务器。</p></li> <li><p>在浏览器访问 <code>192.168.184.129:8080</code> 检查项目是否部署成功。</p></li></ol> <p>至此，ruoyi-admin 已经在 tomcat 中部署好了，下面是实现动静分离的具体配置：</p> <ol><li>首先调整 tomcat 部署后生产的目录 ，主要是将编译后的静态文件的所在目录 static 移动到了 /home/www 目录下，此外将 ruoyi-admin 的国际化资源目录移动到 templates 目录下。</li></ol> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token builtin class-name">cd</span> /home/apps/apache-tomcat-8.5.81/webapps/ROOT
<span class="token function">mv</span> WEB-INF/classes/static/i18n  WEB-INF/classes/templates/i18n 
<span class="token function">mv</span> WEB-INF/classes/static /home/www/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>目录调整后，需要修改 application.yml 配置文件中的国际化资源配置：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">messages</span><span class="token punctuation">:</span>
    <span class="token comment"># 国际化资源文件路径 </span>
    <span class="token comment"># 将 static/i18n/messages 修改为 templates/i18n/messages</span>
    <span class="token key atrule">basename</span><span class="token punctuation">:</span> templates/i18n/messages
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ol start="2"><li>在 /etc/nginx/conf.d/ 目录下新建 8002-ruoyi-war.conf 配置文件，写入如下内容：</li></ol> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">listen</span> <span class="token number">8002</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span> ruoyi.war</span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">proxy_pass</span> http://localhost:8080</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token directive"><span class="token keyword">location</span> ~ \.(js|css|png|jpg|gif|ico)</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">root</span> /home/www/static</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token directive"><span class="token keyword">location</span> = /html/ie.html</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">root</span> /home/www/static</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
    <span class="token directive"><span class="token keyword">location</span> ^~ /fonts/</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">root</span> /home/www/static</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>配置完成之后需要使用命令 <code>nginx -s reload</code> 重新加载 nginx 配置文件，同时重新启动 tomcat 服务器。启动后可能会出现静态资源无法访问的情况，查看 <code>/var/log/nginx/error.log</code> ，若发现权限不足，则需要从如下两个方面进行修改：</p> <ol><li>静态资源存放目录权限不足，可以使用命令 <code>chmod -R 777 /home/www/static</code> 解决。</li> <li>若静态资源存放目录的权限没问题，则需要考虑 <code>/etc/nginx/nginx.conf</code>  配置文件中的 nginx 启动用户和本机的用户是否保持一致，不一致，改为一致即可。</li></ol> <h3 id="_7-4-缓冲-buffer-和缓存-cache"><a href="#_7-4-缓冲-buffer-和缓存-cache" class="header-anchor">#</a> 7.4 缓冲（buffer）和缓存（cache）</h3> <h4 id="_7-4-1-缓冲-buffer"><a href="#_7-4-1-缓冲-buffer" class="header-anchor">#</a> 7.4.1 缓冲（buffer）</h4> <p>缓冲一般放在内存中，如果不适合放入内存（比如超过了指定大小），则会将响应写入磁盘临时文件中。启用缓冲后，nginx 先将后端的请求响应（response）放入缓冲区中，等到整个响应完成后，再发给客户端。nginx 缓冲能够解决由于客户端性能慢而导致与后端服务器长时间连接的问题。</p> <p><img src="https://cdn.jsdelivr.net/gh/mengyahui/image-repository@master/nginx/nginx1.22tw5pxbn5uo.webp" alt="nginx1"></p> <p>开启代理缓冲后，nginx 可以用较快的速度尽可能将响应体读取并缓冲到本地内存或磁盘中，同时根据客户端的网络质量以合适的网速将响应传递给客户端。这样既解决了 server 端连接过多的问题，也保证了能持续稳定的向客户端传递响应。</p> <p><img src="https://cdn.jsdelivr.net/gh/mengyahui/image-repository@master/nginx/nginx2.48e4vngl1so0.webp" alt="nginx2"></p> <p>缓冲（buffer）可以配置在 http、server 或 location 的上下文 context 中，我们可以使用如下指令来调整：</p> <ul><li><p><code>proxy_buffering</code>：这个指令控制所在 context 或者子 context 的 buffer（缓冲） 是否打开。默认是 on。</p></li> <li><p><code>proxy_buffers</code>：这个指令控制缓冲（buffer）的数量（第一个参数）和大小（第二个参数）。默认是 8 个 buffer（缓冲），每个 buffer（缓冲） 大小是 1 个内存页（4k 或 8k）。增加 buffer 的数量可以缓冲更多的信息。</p></li> <li><p><code>proxy_buffer_size</code>：是来自后端服务器 response 信息的一部分，它包含 Headers，从 response 分离出来。这个指令设置 response 的缓冲。默认，它和 proxy_buffers 一样，但是因为它仅用于 Headers，所有它的值一般设置得更低。</p></li></ul> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">proxy_buffers</span> <span class="token number">16</span> <span class="token number">4k</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_buffer_size</span> <span class="token number">2k</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_pass</span> http://localhost:8088</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="_7-4-2-缓存-cache"><a href="#_7-4-2-缓存-cache" class="header-anchor">#</a> 7.4.2 缓存（cache）</h4> <p>启用缓存后，nginx将响应保存在磁盘中，返回给客户端的数据首先从缓存中获取，这样子相同的请求不用每次都发送给后端服务器，减少到后端请求的数量。</p> <p><img src="https://cdn.jsdelivr.net/gh/mengyahui/image-repository@master/nginx/nginx3.4nwbgwi7m96.webp" alt="nginx3"></p> <p>缓存的配置，主要射击如下几个指令：</p> <ol><li><strong>proxy_cache_path</strong></li></ol> <p>使用缓存（cache）时，需要先在 http 的上下文中使用 <code>proxy_cache_path</code> 指令来配置缓存的本地文件目录、名称和大小，其语法格式如下：</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">proxy_cache_path</span> path [levels=number] keys_zone=zone_name:zone_size [inactive=time][max_size=size]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>path：缓存的本地文件目录。</li> <li>levels：指定该缓存空间对应的目录层级，最多可以设置3层，每层取值为 1|2。</li></ul> <p>默认情况下，本地缓存目录中的文件名为 <code>proxy_cache_key</code> 的 MD5 值，<code>proxy_cache_key</code> 默认值是：</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">proxy_cache_key</span> <span class="token variable">$scheme</span><span class="token variable">$proxy_host</span><span class="token variable">$uri</span><span class="token variable">$is_args</span><span class="token variable">$args</span></span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>假设 proxy_cache_key 的值为 <code>43c8233266edce38c2c9af0694e2107d</code>，下面是对 levels 的举例说明：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token assign-left variable">levels</span><span class="token operator">=</span><span class="token number">1</span>:2   <span class="token comment"># 表示最终的存储路径为 path/d/07</span>
<span class="token assign-left variable">levels</span><span class="token operator">=</span><span class="token number">2</span>:1:2 <span class="token comment"># 表示最终的存储路径为 path/7d/0/21</span>
<span class="token assign-left variable">levels</span><span class="token operator">=</span><span class="token number">2</span>:2:2 <span class="token comment"># 表示最终的存储路径为 path/7d/10/e2</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>keys_zone：用来为这个缓存区设置引用名称和大小。</li> <li>inactive：指定缓存的数据多次时间未被访问就将被删除，如 inactive=1d 表示缓存数据 1 天内没有被访问就会被删除。</li> <li>max_size：设置最大缓存空间，如果缓存空间存满，默认会覆盖缓存时间最长的资源。</li></ul> <ol start="2"><li><strong>proxy_cache</strong></li></ol> <p><code>proxy_cache</code> 指令来使用缓存，可以在 http、server 和 location 的 context 中使用，下面是一个在 location 的 context 中使用 <code>proxy_cache</code> 指令的例子。</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">http</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">proxy_cache_path</span> /var/lib/nginx/cache keys_zone=mycache:10m</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
            <span class="token directive"><span class="token keyword">proxy_cache</span> mycache</span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">proxy_pass</span> http://localhost:8000</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>在上面的代码中，我们使用 <code>proxy_cache_path</code> 指令来定义了一个名为 mycache 大小为 10m 的缓存，缓存的本地目录是 <code>/var/lib/nginx/cache</code> ，如果这个路径不存在，则需要创建这个目录，并赋予正确的权限：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /var/lib/nginx/cache
<span class="token function">chmod</span> <span class="token number">700</span> /var/lib/nginx/cache
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ol start="3"><li><strong>proxy_cache_min_uses</strong></li></ol> <p>缓存不应该设置的太敏感，可以使用 <code>proxy_cache_min_uses</code> 设置相同的 key 的请求，访问次数超过指定数量才会被缓存，其可以在 http、server 和 location 的 context 中使用。</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">proxy_cache_min_uses</span> <span class="token number">5</span></span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="4"><li><strong>proxy_cache_valid</strong></li></ol> <p>默认情况下，响应会无限期的保留在缓存中，仅当缓存超过最大配置大小时，按照时间删除最旧的数据。除此之外，我们还可以使用 <code>proxy_cache_valid</code> 指令配置缓存的存活时长，该指令可以配置在 http、server 和 location 的 context 中。</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">http</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">proxy_cache_path</span> /var/lib/nginx/cache keys_zone=mycache:10m</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
            <span class="token directive"><span class="token keyword">proxy_cache</span> mycache</span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">proxy_cache_valid</span> <span class="token number">200</span> <span class="token number">302</span> <span class="token number">10m</span></span><span class="token punctuation">;</span> <span class="token comment"># 成功的请求缓存保留10分钟</span>
        	<span class="token directive"><span class="token keyword">proxy_cache_valid</span> <span class="token number">404</span>      <span class="token number">1m</span></span><span class="token punctuation">;</span> <span class="token comment"># 404的请求缓存保存1分钟</span>
        	<span class="token directive"><span class="token keyword">proxy_cache_valid</span> any <span class="token number">5m</span></span><span class="token punctuation">;</span>	   <span class="token comment"># 其他请求缓存保存5分钟 </span>
            
            <span class="token directive"><span class="token keyword">proxy_pass</span> http://localhost:8000</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><strong>配置案例：</strong></p> <p>配置 ruoyi-admin.jar 的反向代理，缓存请求的静态文件。</p> <ol><li>在 <code>/etc/nginx/conf.d/</code> 目录下新建 8003-ruoyi-cache.conf 配置文件，写入内容如下：</li></ol> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">proxy_cache_path</span> /var/cache/nginx/data keys_zone=static:100m</span><span class="token punctuation">;</span>

<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>

    <span class="token directive"><span class="token keyword">listen</span> <span class="token number">8003</span></span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">proxy_pass</span> http://localhost:8088</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token directive"><span class="token keyword">location</span> ~ \.(js|css|png|jpg|gif|ico)</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">proxy_cache</span> static</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_cache_valid</span> <span class="token number">200</span> <span class="token number">302</span> <span class="token number">10m</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_cache_valid</span> <span class="token number">404</span>      <span class="token number">1m</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_cache_valid</span> any <span class="token number">5m</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_cache_min_uses</span> <span class="token number">1</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_pass</span> http://localhost:8088</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token directive"><span class="token keyword">location</span> = /html/ie.html</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">proxy_cache</span> static</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_cache_valid</span> <span class="token number">200</span> <span class="token number">302</span> <span class="token number">10m</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_cache_valid</span> <span class="token number">404</span>      <span class="token number">1m</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_cache_valid</span> any <span class="token number">5m</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_cache_min_uses</span> <span class="token number">1</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_pass</span> http://localhost:8088</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
    <span class="token directive"><span class="token keyword">location</span> ^~ /fonts/</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">proxy_cache</span> static</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_cache_valid</span> <span class="token number">200</span> <span class="token number">302</span> <span class="token number">10m</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_cache_valid</span> <span class="token number">404</span>      <span class="token number">1m</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_cache_valid</span> any <span class="token number">5m</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_cache_min_uses</span> <span class="token number">1</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_pass</span> http://localhost:8088</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><ol start="2"><li>接着，启动 ruoyi-admin.jar 并使用命令 <code>nginx -s reload</code> 重新加载 nginx 配置文件。</li> <li>项目启动完成，访问项目路径后，可在 <code>/var/cache/nginx/data</code> 目录下查看是否生成了缓存文件。</li></ol> <h3 id="_7-5-负载均衡"><a href="#_7-5-负载均衡" class="header-anchor">#</a> 7.5 负载均衡</h3> <p>如果请求数过大，单个服务器解决不了，我们增加服务器的数量，然后将请求分发到各个服务器上，将原先请求集中到单个服务器的情况改为请求分发到多个服务器上，就是负载均衡。</p> <p>upstream 指定后端服务器地址列表，在 server 中拦截响应请求，并将请求转发到 upstream 中配置的服务器列表。</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">upstream</span> nacos-server</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">server</span> localhost:8080</span><span class="token punctuation">;</span>
	<span class="token directive"><span class="token keyword">server</span> localhost:8088</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span> 
    <span class="token directive"><span class="token keyword">server_name</span>  ruoyi.apps</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">listen</span> 		 <span class="token number">8004</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">location</span> /nacos</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">proxy_pass</span> http://nacos-server</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>不做任何配置的情况下，nginx 会采用轮询的方式分发请求，除此之外，还可以配置如下几种负载均衡策略：</p> <h4 id="_7-5-1-最小连接-least-conn"><a href="#_7-5-1-最小连接-least-conn" class="header-anchor">#</a> 7.5.1 最小连接（least-conn）</h4> <p>将下一个请求分配给活动连接数最少的服务器（较为空闲的服务器）。</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">upstream</span> backend</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">least_conn</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span> backend1.example.com</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span> backend2.example.com</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>需要注意的是，无论是使用轮询机制还是最小连接机制，相同客户端的请求都有可能分发到不同的服务器，不能保证同一个客户端始终定向到同一台服务器。</p> <h4 id="_7-5-2-ip-hash"><a href="#_7-5-2-ip-hash" class="header-anchor">#</a> 7.5.2 ip-hash</h4> <p>客户端的 IP 地址将用作哈希键，来自同一个 IP 的请求会被转发到相同的服务器。</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">upstream</span> backend</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">ip_hash</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span> backend1.example.com</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span> backend2.example.com</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="_7-5-3-hash"><a href="#_7-5-3-hash" class="header-anchor">#</a> 7.5.3 hash</h4> <p>通用 hash，允许用户自定义 has h的 key，key 可以是字符串、变量或组合，如：</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">upstream</span> backend</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">hash</span> <span class="token variable">$request_uri</span> consistent</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span> backend1.example.com</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span> backend2.example.com</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>基于 IP 的哈希算法存在一个问题，那就是当有一个上游服务器宕机或者扩容的时候，会引发大量的路由变更，进而引发连锁反应，导致大量缓存失效等问题。</p> <p>为了解决这个问题，可以配置 <code>consistent</code> 参数，<code>consistent</code> 参数启用 ketama 一致哈希算法，如果在上游添加或删除服务器，只会重新映射部分键，从而最大限度地减少缓存失效。‎</p> <h4 id="_7-5-4-随机-random"><a href="#_7-5-4-随机-random" class="header-anchor">#</a> 7.5.4 随机（random）</h4> <p>每个请求都将传递到随机选择的服务器。</p> <p>two 是可选参数，nginx 在考虑服务器权重的情况下随机选择两台服务器，然后使用指定的方法选择其中一台，默认为选择连接数最少（least_conn‎）的服务器。</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">upstream</span> backend</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">random</span> two least_conn</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span> backend1.example.com</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span> backend2.example.com</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span> backend3.example.com</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span> backend4.example.com</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="_7-5-5-权重-weight"><a href="#_7-5-5-权重-weight" class="header-anchor">#</a> 7.5.5 权重（weight）</h4> <p>根据服务器的权重来分发请求。</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">upstream</span> my-server</span> <span class="token punctuation">{</span>
  
    <span class="token directive"><span class="token keyword">server</span> performance.server weight=3</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span> app1.server</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span> app2.server</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="_7-5-6-健康检查"><a href="#_7-5-6-健康检查" class="header-anchor">#</a> 7.5.6 健康检查</h4> <p>在反向代理中，如果后端服务器在某个周期内响应失败次数超过规定值，nginx会将此服务器标记为失败，并在之后的一个周期不再将请求发送给这台服务器。</p> <p>通过 <code>fail_timeout</code>‎ 参数来设置检查周期，默认为 10 秒。</p> <p>通过 <code>max_fails</code> 参数来设置检查失败次数，默认为 1 次。</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">upstream</span> backend</span> <span class="token punctuation">{</span>
  <span class="token directive"><span class="token keyword">server</span> backend1.example.com</span><span class="token punctuation">;</span>
  <span class="token directive"><span class="token keyword">server</span> backend2.example.com max_fails=3 fail_timeout=30s</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></div></div>  <div class="page-edit"><!----> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2023/06/18, 09:28:38</span></div></div> <div class="page-nav-wapper"><!----> <!----></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:2772540969@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/mengyahui" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2022-2023
    <span>MYH | <a href="https://github.com/mengyahui/blob/main/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.67223bcb.js" defer></script><script src="/assets/js/2.316bc55b.js" defer></script><script src="/assets/js/48.5e0e4526.js" defer></script>
  </body>
</html>
